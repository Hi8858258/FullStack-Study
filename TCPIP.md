#   TCP/IP

## 一.网络分层

四层：应用层>运输层>网络层>链路层

链路层：处理与电缆的物理接口细节(设备驱动程序及接口卡)

网络层：处理分组在网络中的活动，例如分组选路(IP,ICMP,IGMP)

运输层：为两台主机上的应用程序提供端到端的通讯(TCP,UDP)

应用层：处理特定的应用程序细节（Telnet,FTP,e-mail）

![image-20200609203051399](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200609203051399.png)

上图是运行FTP的两台主机：

特点：1. 双方都有对应的一个或多个协议进行通讯

​		    2.应用程序通常是用户进程，而下三层一般在内核进行

​		    3.应用层关心应用程序的细节，下三层处理通讯细节

#### 1.1通过路由器连接的两个网络

![image-20200610052821662](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610052821662.png)

特点：

- 应用层和运输层使用端到端（end-to-end）协议

- 网络层提供的是逐条协议

- 网络IP提供的是一种不可靠的服务（可能会丢包），他只是尽可能快的把分组从源结点送到目的结点。但不能提供可靠性保障

- TCP在不可靠的IP层上提供一个可靠的运输层

- 互联网的目的之一就是在应用程序中隐藏所有的物理细节，将下层协议封装，好让应用层可以不用去管下层协议

  

##### 1.1.1如何理解TCP在不可靠的IP层上提供一个可靠的运输层

![image-20200610054629228](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610054629228.png)

TCP协议是淘宝买家和卖家之间的协议，卖加必须保证包裹要送到买家手里，如果在网络层（通过IP寄包裹，是可能会造成丢包的）出现丢包，那么买家就会出现超时等待的情况，卖加就必须要遵守TCP协议重新寄一个包裹，买家收到包裹后给卖加发送确认收件的消息，不然卖加会一直发送造成损失。

#### 1.2TCP/IP协议族中不同层次的协议

![image-20200610055311905](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610055311905.png)

### 

- TCP使用不可靠的IP服务，并提供可靠的而运输层服务

- UDP为应用程序发送和接受数据报，和TCP不同，UDP是不可靠的，丢包就丢包了（所以UDP常用于视频，语音，网游等即时性要求较高的应用，这些应用如果采用TCP将会让使用者崩溃的）

- IP是网络层上主要的协议，同时被TCP和UDP使用

- ICMP是IP协议的附属协议，它会告诉数据发送者丢包的原因（典型使用ICMP的应用程序就是ping一个网址，会告诉我们为什么ping不通）

  很少有应用程序直接调用IP协议的情况

#### 1.3 封装

![image-20200610060305133](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610060305133.png)

- 以太网数据帧的物理特性就是其长度必须在46-1500字节之间（1500也称为MTU）
- 以太网的帧首部也有一个16bit的帧类型域,告诉下一个是什么类型的协议（ip,arp,rarp）
- IP在首部中存入一个长度为8bit的数值，称作协议域也是用来指向下一个协议的（icmp,igmp,tcp,udp,esp,gre）
- TCP和UDP都用一个16bit的端口号来表示不同的应用程序（ftp,telnet,http）

#### 1.4 分用

![image-20200610061222694](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610061222694.png)

解封装，解析每一层的头部，找下一层是哪个协议进行分用

#### 1.5端口号

- 服务器一般都是通过知名端口号来识别的（如http 80，ftp 21, telnet 23）
- 客户端口号又称为临时端口号（即存在时间很短暂）
- 大多数TCP/IP实现给临时端口分配1024-5000之间的端口号
- 大于5000端口号是为其他服务器预留的（internet上并不常用的服务）

#### 1.6 链路层：以太网和IEEE 802封装

- 以太网

  a.以太网这个术语一般是指数字设备公司（inter等）在1982年联合发布的一个标准

  b.它采用一种称作CSMD/CD的媒体接入方法

  c.它的速率为10Mb/s，地址为48bit（MAC地址）

- IEEE802封装（不常用）

  a.802.3针对整个CSMD/CD网络

  b.802.4针对令牌总线网络

  ​	802.5针对令牌环网络

##### 封装格式

![image-20200610063425986](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200610063425986.png)

- 两种帧格式都采用48bit（6字节）的目的地址和源地址
- ARP和RARP协议对32bit的IP地址和48bit的硬件地址进行映射
- 802定义的有效长度值与以太网的有效类型值无一相同，这样就可以对两种帧格式进行区分
- 目的服务访问点（Destination Service Access Point, DSAP） 和源服务访问点（Source Service Access Point, SSAP）的值都设为0 x a a。Ctrl字段设为3。随后的3个字节org code都置为0.再接下来的2个字节类型字段和以太网帧格式一样
- 802.3规定数据部分必须至少为38字节，而对于以太网，则要求最少要有46字节。为了保证这一点，必须在不足的空间插入填充（pad）字节

区分以太网和802帧的方法就是，去看第三个数据。前两个数据目的地址，源地址都是一样的，但第三个数据802是长度，以太网是类型，完全不同。

以太网类型中的数据就代表数据包的协议类型。如0800代表IP，0806代表ARP，8035代表请求/应答。

如果以太网的数据包不够46字节就会用pad来补齐，看上图中的ARP协议只占了28字节，后面用pad补齐了。超过1500就会分片